$def with(books=[], title="", url="", key="", min_books=1, load_more=None, test=False)

$ availability_types = {'open': {'cls': 'available', 'cta': 'Read'}, 'borrow_available': {'cls': 'available', 'cta': 'Borrow'}, 'borrow_unavailable': {'cls': 'unavailable', 'cta': 'Join Waitlist'}, 'error': {'cls': 'missing', 'cta': 'No eBook'}}

$ cover_host = '//covers.openlibrary.org'
$ fallback_cover = 'https://archive.org/services/img/'

$def render_carousel_cover(book, lazy_cover):
  $if book.get('availability'):
    $ availability_status = book['availability']['status']
    $ ocaid = book['availability'].get('identifier') or book.get('ocaid') or book.get('ia')
  $else:
    $ ocaid = book.get('ocaid') or book.get('ia')
    $ availability_status = 'open' if ocaid else 'error'

  $ availability = availability_types[availability_status]
  $ url = book.get('key') or book.url
  $ cta_url = ('/borrow/ia/%s' % book.get('ia')) if availability == 'borrow_available' else url
  $ title = book.title
  $if book.get('cover_url'):
    $ cover_url = book.get('cover_url')
  $elif book.get('cover_id'):
    $ cover_url = '%s/b/id/%s-M.jpg' % (cover_host, book.get('cover_id'))
  $else:
    $ cover_url = '%s/b/ia/%s-M.jpg?default=%s%s' % (cover_host, ocaid, fallback_cover, ocaid)
  $ img_attr = 'data-lazy' if lazy_cover else 'src'
  $if book.get('authors'):
    $ author_names = [author.name for author in book.authors]
    $ byline = ' by ' + ', '.join(author_names)
  $else:
    $ byline = ''

  <div class="book carousel__item">
    <div class="book-cover">
      <a href="$(url)">
        <img class="bookcover" width="130" height="200" title="$('%s%s' % (title, byline))"
             $img_attr="$(cover_url)"/>
      </a>
    </div>
      <div class="book-cta">
        <a class="cta-btn cta-btn--$(availability['cls'])"
           href="$cta_url" data-ol-link-track="$key" title="$(availability['cta']): $book.title"
           data-key="$key" data-ocaid="$ocaid">$availability['cta']</a>
      </div>
  </div>

$if test or (books and len(books) >= min_books):
      <div class="carousel-section">
      $if title and url:
        <div class="carousel-section-header">
          <h2 class="home-h2"><a href="$url">$title</a></h2>
        </div>
      <div class="carousel-container carousel-container-decorated">
        $ attrs = ''
        <div class="carousel carousel-$key">
          $for index, book in enumerate(books or []):
              $:render_carousel_cover(book, index > 5)
        </div>
        <script type="text/javascript">
              window.q.push(function() {
                var addWork = function(work) {
                  var ocaid = work.availability.identifier;
                  var availabilityTypes = $:(availability_types);
                  var availability = work.availability.status;
                  var cover_id = work.covers? work.covers[0] : work.cover_id;
                  var cover_url = cover_id ? '//covers.openlibrary.org/b/id/' + cover_id + '-M.jpg' :
                    '$(cover_host)/b/ia/' + ocaid + '-M.jpg?default=$(fallback_cover)' + ocaid;
                  var cls = availabilityTypes[availability].cls;
                  var url = (cls == 'cta-btn--available') ?
                      ('/borrow/ia/' + ocaid) : (cls == 'cta-btn--unavailable') ?
                        ('/books/' + work.availability.openlibrary_edition) : work.key;
                  var cta = availabilityTypes[availability].cta;
                  var isClickable = availability == 'error' ? 'disabled' : '';

                  return '<div class="book carousel__item slick-slide slick-active" ' +
                      '"aria-hidden="false" role="option">' +
                      '<div class="book-cover">' +
                        '<a href="' + work.key + '" ' + isClickable + '>' +
                          '<img class="bookcover" width="130" height="200" title="' +
                            work.title + '" src="' + cover_url + '">' +
                        '</a>' +
                      '</div>' +
                      '<div class="book-cta">' +
                        '<a class="btn cta-btn cta-btn--' + cls + '" href="' + url +
                          '" data-ol-link-track="$key" ' +
                          'title="' + cta + ': ' + work.title +
                          '" data-key="$key" data-ocaid="' + ocaid + '">' + cta +
                        '</a>' +
                      '</div>' +
                    '</div>';
                }

                Carousel.add(
                  '.carousel-$key', // dom element to bind slick
                  6, 5, 4, 3, 2, 1, { // num books per responsive breakpoint
                  $if load_more:
                     url: '$:(load_more["url"].replace("&amp;", "&"))',
                     getItems: function(results) { return results.works },
                     addItem: addWork,
                     pageMode: '$(load_more.get("mode", "offset"))',
                     limit: $(load_more.get("limit", 18))
                  });
              });
        </script>
      </div>
    </div>
